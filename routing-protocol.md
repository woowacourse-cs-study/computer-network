# Network Layer
## 라우터  
라우팅, 즉 **Path Determination (경로결정)** 과 **Switching (스위칭)** 을 주로 하는 장비  
- 라우팅: 패킷을 목적지에 전달하기 위해 경로 정보를 각 노드가 판단할 수 있게 하고 경로 정보에 따라 패킷을 전달하는 것  
- 경로 결정: 데이터 패킷이 목적지까지 가는 길을 검사하고 어떤 경로로 패킷이 가는 것이 적절한지 판단  
- 스위칭: 경로가 결정되면 그 방향으로 패킷을 보내는 것  
1. 랜 테이블 검사를 한다. 이곳에서는 패캣의 목적지가 같은 네트워크에 있는지 아니면 다른 네트워크에 있는지를 확인한다.  
2. 네트워크 테이블을 검사하여 패킷을 전달할 네트워크 주소를 찾아낸다.  
3. 라우팅 테이블을 검색하여 가장 적합한 경로를 찾아내서 패킷을 보낸다.  

## 라우팅 프로토콜  
라우터가 패킷을 목적지까지 전달하기 위해 인접한 라우터 사이에서 경로정보를 작성하고 제어하는 프로토콜  
라우팅 테이블을 참조해 가장 좋은 길로 패킷을 전송하는 방법을 결정해준다.  
1. 전송받은 패킷의 헤더에 포함된 Destination Address와 Routing Table 내에 정보를 비교한다.
2. Destination 네트워크까지 패킷을 확실히 전달하기 위해 자신이 가지고 있는 어떤 interface에서 패킷을 보내면 좋을까 판단한다.
3. 만일 자신의 Routing Table에 일치하는 정보가 없을 경우, 패킷을 파기한다.  

- 스태틱 vs 다이나믹  
![image](https://user-images.githubusercontent.com/43775108/125487500-e7740d0b-2ed9-4030-bef8-144dff5b91b6.png)  

- AS(Autonumous System)  
하나의 거대한 네트워크 관리자(ex 회사, 통신 사업자)에 의해 관리되는 라우터들의 집단.
라우팅을 위해 자율적으로 관리할 수 있는 네트워크 그룹과 게이트웨이  

## IGP(Internal Gateway Protocol)  
AS 사이에서의 라우팅 프로토콜  
ex) RIP, OSPF, IGRP  

### RIP(Routing Information Protocol)  
현재까지 가장 많이 사용되는 프로토콜로 DVRP(Distance Vector Routing Protocol) 방식을 사용하는 LAN 구간에서의 대표적인 프로토콜이다.  
메시지 송수신에 UDP 포트를 사용한다. v1, v2는 520번 ng는 521번  

![스크린샷 2021-07-12 오전 1 48 17](https://user-images.githubusercontent.com/43775108/125203441-4f285a00-e2b3-11eb-8d05-4b4432c41c0c.png)  
1. A의 경우 N1, N3, N4에 대한 정보만을 갖는 라우팅 테이블 구성  
2. 인접한 네트워크는 1로, 그 외 네트워크는 무한대로 설정  
3. A는 B, D, E와 라우팅 테이블 교환  
4. 첫번째 라우팅 정보 교환하면 A는 몰랐던 N2, N5, N6에 대한 정보 얻어서 반복해서 정보 알아감  
이렇게 라우팅 테이블을 얻으면 요청이 들어왔을 때 패킷에 담긴 명령, 버전, 네트워크 패밀리(사용된 프로토콜 계열), 네트워크 주소, 메트릭(홉 수) 에서 올바른 라우터 찾아 전달  

- Distance Vector  
거리와 방향으로 길을 찾아가는 알고리즘  
각각의 라우터는 인접한 라우터에 주기적으로 라우팅 정보 전달해 경로 선택한다. 이는 30초마다 라우팅 정보를 업데이트해서 전달한다.  

- Hop Count  
Metric으로 도달할 목적지까지의 거치는 게이트웨이의 수로 15개로 제한한다.  
이렇게 짧게 제한하고 있기 때문에 IGP로 사용되는 것이다.  

- RIP version1 vs version2  
![image](https://user-images.githubusercontent.com/43775108/125487632-f1b69d4f-91d7-401b-9827-fece97970328.png)  

- 성능 개선  
triggered udpate: 홉 수 변경 시 즉시 통보해 복구 시간 줄임  
holddown: 메트릭이 무한인 경로는 경로 갱신하지 않고 전체 갱신될 때까지 기다림  
split horizon: a -> b -> c 시에 b->c 사이에 장애 발생해서 a->b 무한 루프돌 때 b가 a에 보낸 정보를 다시 안보내게 하는 것  
poisoning: 회선이 고장나면 메트릭을 16으로 지정해 전체 네트워크에 알려 도달 불가능 알림  

### VRRP(Virtual Router Rebundancy Protocol)  
정적으로 구성된 라우터 사용 시 하나의 라우터를 LAN 상의 호스트 그룹에서 패킷을 전달하기 위한 라우터로 사용하도록 하여 하나 이상의 백업 라우터를 가질 수 있도록 하는 프로토콜  
가상 IP 주소를 수동으로 지정하거나 DHCP를 기본값으로 지정할 수 있다.  
가상 IP 주소는 라우터 간 공유되어 하나는 마스터 라우터, 나머지는 백업으로 지정되어 마스터에 장애가 발생하면 백업 IP 주소가 매핑된다.  

### OSPF(Open Shortest Path Fast)  
최단경로를 우선으로 하는 프로토콜로, 모든 라우터가 동일한 네트워크 topology database를 사용해 경로 계산하는 프로토콜이다.  
라우팅 루프가 발생하지 않고 플러딩(갱신 정보를 인접에, 인접이 또 인접에 전달)을 통해 갱신 속도를 향상시킨다.  
AS 안에서 Area들을 갖는 계층적인 구성을 통해 라우팅 테이블의 수를 줄여 트래픽 감소시킬 수 있고, 라우팅 경로 선택에 있어 효율적으로 짧은 경로를 선택할 수 있다.  
VLSM(Variable Length Subnet Mask)을 지원하기 때문에 IP 주소를 효율적으로 사용할 수 있고 라우팅 테이블을 줄일 수 있다.  

- Area  
인접한 OSPF 네트워크와 호스트의 집합, OSPF AS에 의해 논리적으로 구분됨  
- AS  
OSPF Inter Network에서 가장 큰 개체로 같은 라우팅 방법을 가진 네트워크들의 집합  

- 동작과정  
1. OSPF가 Hello 패킷을 보내 인접 라우터를 찾는다
2. OSPF 라우터 간 공유하는 라우터 ID를 통해 헬로 패킷을 전송한다. 브로드캐스트(`255.255.255.255`)가 아닌 멀티캐스트 주소(`224.0.0.5`)로 전송한다.
3. 헬로 패킷 안에는 DR, BDR을 결정하기 위한 Priority 필드가 존재한다.
4. OSPF 라우터는 헬로 패킷 송수신을 통해 Neighbor 관계를 유지한다.

- Link State 알고리즘  
인접한 라우터로 각 라우터의 고유 접속 정보만 전달  
각 라우터는 각 인터페이스의 정보를 포함한 접속 정보를 생성하고 유지해 한 AS 내에 있는 모든 라우터에게 접속 정보 전달  
라우터들은 각각 DB를 작성하고 갖고 최단 경로 알고리즘을 통해 최단 경로를 설정  

![스크린샷 2021-07-12 오전 2 09 44](https://user-images.githubusercontent.com/43775108/125204051-3bcabe00-e2b6-11eb-96ee-21e312c5eaa4.png)  
1. 모든 노드 집합 M  
2. N에 출발 노드 삽입  
3. M에 있는 노드가 출발 노드와 비슷하다면 비용 기록, 아니면 무한대  
4. 비용 기록 값 최소 노드 찾아 N에 삽입  
5. 최소 노드에 인접하고 N에 없는 노드가 최소 노드 통하는 경우와 아닌 경우 비용 계산해 최소값을 갱신  
6. 모든 노드가 N에 포함될 때까지 과정 반복  

- LSA(링크 상태 광고)  
인접 라우터 간의 동기화 과정이 끝나고 링크 상태에 변화가 있을 때만 메트릭 값과 링크 속성에 대한 정보 전송  
라우터 링크, 네트워크 링크, 요약 링크, AS 링크로 나눠져 광고  

### IGRP(Interior Gateway Routing Protocol)  
주기적으로 인접 라우터와 라우팅 정보 교환하는 프로토콜  
RIP와 달리 다중 경로에 대한 라우팅 수행  
라우팅 테이블에 다음 홉만을 기록해 라우터는 메트릭 값을 토대로 트래픽 분배  
하나의 메트릭(hop count)을 사용하며 다양한 네트워크 파라미터를 이용해 거리 벡터 계산  
목적지에 대해 최대 4개까지의 경로를 관리해 라우팅을 지원  
네트워크 구성 변화에 빠르게 반응하고 라우팅 테이블 갱신을 위해 꼭 필요한 정보만 전송해 회선에 대한 오버헤드 감소  

메트릭 요소  
- 대역폭: 회선 속도  
- 지연: 회선을 사용해 전송에 걸리는 시간  
- 신뢰도: 라우터가 동적 측정  
- 부하: 부하 정도를 나타내는 단위  
- MTU: 회선이 처리할 수 있는 최대 프레임 크기  

`메트릭 = K1대역폭 + K2대역폭/(256-부하) + K3지연`  

## EGP(External Gateway Protocol)  
AS(Autonomous System)끼리의 라우팅 프로토콜  
ex) BGP  

### BGP(Border Gateway Protocol)  
정해진 정책에 의하여 최적 라우팅 경로 수립, 경로 벡터(Distance Vector) 방식의 라우팅 프로토콜이다.  
도메인 간의 라우팅 정보 전달한다. AS 번호를 메트릭으로 사용하는 `Path Vector` 사용한다.  
AS 내부에 여러 BGP 라우터가 존재할 수 있어 AS 연결을 제공하는 transmit AS 제공한다.(동일 AS 간: IBGP, 다른 AS 간: EBGP)  
TCP 포트 179번을 통해 인접 라우터들과 Neighbor 관계를 성립한다. Neighbor 라우터 간에는 유니캐스트 라우팅 업데이트 실시한다.  

![스크린샷 2021-07-12 오전 2 22 00](https://user-images.githubusercontent.com/43775108/125204380-f1e2d780-e2b7-11eb-9311-54e160dc58d2.png)  
1. AS4는 자신과 직접 연결되어있는 네트워크를 백본 네트워크에 알림  
2. 백본 네트워크는 AS4가 준 네트워크 접근 경로를 BGP를 통해 공지하고 그 반대로 AS1, AS3을 통해 또 접근할 수 있다고 알리며 서로 알게 된다.    

<br>

## 캐스트  
네트워크가 통신하는 방법  

### 브로드캐스트  
![image](https://user-images.githubusercontent.com/43775108/125485142-33aecca5-2b5a-4e16-a67b-0bc82715935d.png)
같은 네트워크에 있는 모든 장비에 프레임을 보내는 통신이다.  
브로드캐스트용 주소가 미리 정해져있고, 수신 받는 시스템은 이 주소가 오면 패킷을 자신의 CPU로 전송하고 CPU가 패킷을 처리하는 방식을 사용한다.  
상대 IP는 알지만 MAC 모를 때, 네트워크에 있는 모든 시스템에 알리는 경우, 라우터 간 정보를 교화하는 경우 사용한다.    
IPv4가 사용한다.  
- 패킷이 전송되어 트래픽 증가, CPU 처리로 인한 성능 저하  

### 유니캐스트  
![image](https://user-images.githubusercontent.com/43775108/125486038-ede06638-3c5b-4462-8212-59ab9425cf58.png)  
MAC 주소 기반, 출발지 == 목적지여야 하는 일대일 통신  
송신 노드 하나가 수신 노드 하나에 전송하는 일대일 방식  
프레임에 자신의 MAC 주소와 목적지의 MAC 주소를 첨부해 전송  
- CPU 성능에 문제되지 않음  

### 멀티캐스트 
![image](https://user-images.githubusercontent.com/43775108/125485171-d371144d-471f-4ee1-9e74-2e07fc01068f.png)  
네트워크에 연결되어 있는 시스템 중 특정 그룹에게만 정보를 전송하는 방법  
유니캐스트가 모든 MAC 확인해야 해서 성능이 떨어지고, 브로드캐스트가 모든 네트워크에 보내게 되니 관련 없는 애들이 받을 것을 개선하고자 특정 그룹을 지정해 그 그룹에만 보내는 것  
헤더에 수신자의 주소 대신 수신자들이 참여하고 있는 그룹 주소를 표시해 패킷 전송  
송신 노드 하나가 네트워크에 연결된 하나 이상의 수신 노드에 전송  
- 라우터가 멀티캐스트를 지원해야만 함, UDP를 사용해 신뢰성 저하  

### 애니캐스트  
가장 가까운 노드와 통신  
트래픽 분산, 네트워크 이중화, response time 최소화를 위해 사용  
송신 노드가 네트워크에 연결된 가장 가까운 하나의 노드에 전송  
IPv6가 사용  

#### 정리
[바다](https://www.notion.so/CS-DHCP-0092cd6bd41041ae85db78715009f156), [파피](https://www.notion.so/fa5658b2b67f45c7bd62bb44acf8f8d9), [제리](https://www.notion.so/RIP-OSPF-BGP-DHCP-991a90c7bd2d4ef589fd6f9ff282fbb7), [피카](https://github.com/pika96/TIL/blob/master/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/%EB%9D%BC%EC%9A%B0%ED%84%B0.md), [샐리](https://dusdn1702.github.io/techcourse/106)  
