# Network Layer
데이터 링크에서 MAC 주소를 기반으로 한 같은 네트워크에 있는 통신을 지원한다면,  
네트워크 계층은 IP 주소를 기반으로 서로 다른 네트워크의 소통을 가능하게 한다.  

## IP
네트워크 환경에서 패킷 교환을 위해 네트워크를 찾아가는 주소로 컴퓨터(노드) 간 통신하기 위해 각 컴퓨터에게 부여된 네트워크 상 주소로 변화할 수 있다.  
네트워크 주소와 호스트 주소로 나뉜다.  
- 네트워크 주소  
네트워크 고유의 번호  
- 호스트 주소  
각각의 컴퓨터를 나타내는 번호로 자유롭게 할당할 수 있다.  

### IPv6
- source 와  destination 주소가 128 bit (16 bit씩 8개의 블럭)
- 예시 `2001:0db8:0000:0000:8a2e:0370:7334`
- IP주소 고갈 문제의 해결을 위한 미래를 위한 주소체계
- 고속 전송 & 멀티미디어 트래픽을 지원
- 상용화 X, 근래에는 스마트폰에서 내부적으로 사용(핫스팟)  

### IPv4
- source 와 destination 주소가 32 bit
- 32자리로 이루어진 2진수, 하나의 10진수는 8자리의 2진수로 대체되고 이를 `옥텟` 이라고 부르고, ip 주소는 4개의 옥텟으로 구성된다. 
- `192.168.1.2` : `192.168.1` 까지가 네트워크 주소(공통부분)이고 `2` 는 나만의 호스트 IP(식별할 수 있는 부분)

### IP주소의 클래스  
네트워크의 크기에 따라 하나의 네트워크에서 몇 개의 호스트 IP를 가질 수 있을지 구분하는 것이다.
- A 클래스  
네트워크 128개, 한 네트워크 당 발생할 수 있는 아이피 개수는 16777216개  
첫 옥텟이 네트워크 부분, 0으로 시작, 나머지가 호스트 부분으로 0.0.0.0 ~ 127.255.255.255
- B 클래스  
네트워크 16384개, 아이피 개수 65536개  
첫번째, 두번째가 네트워크, 10으로 시작, 나머지가 호스트, 128.0.0.0 ~ 191.255.255.255
- C 클래스  
네트워크 2097152개, 256개  
첫번째, 두번째, 세번째가 네트워크, 110으로 시작, 나머지가 호스트, 192.0.0.0 ~ 223.255.255.255  
- D 클래스, E 클래스  
멀티캐스트, 연구용으로 잘 사용되지 않음

### 사설 IP
![사설 ip](https://user-images.githubusercontent.com/43775108/125102544-5a924e80-e116-11eb-8223-7c9b4e425d75.png)  
외부에서 접속할 수 있는 공인 IP만 공유기에 할당하고 공유기에 연결된 기기들은 내부에서만 사용할 수 있는 사설 IP를 할당한다.  
사설 IP는 내부에서만 사용할 수 있어 외부 IP와 중복되어도 상관없다.  
- NAT  
공인 IP와 사설 IP를 변환해준다.  
아래 과정을 통해 동작한다.  
1. 호스트가 자신의 IP와 출발지 포트번호와 함께 패킷을 전송
2. NAT 라우터는 패킷을 받아서 패킷에 대한 출발지 포트번호 생성, IP 주소 변경하고 포트번호 변경  
3. 웹 서버는 NAT 라우터 IP와 포트번호 응답  
4. 패킷이 NAT 라우터에 도착했을때 라우터는 사설망 IP 주소와 포트번호로 응답 패킷 전송  

#### 포트포워딩 
![포트포워딩](https://user-images.githubusercontent.com/43775108/125103178-0f2c7000-e117-11eb-9410-4e0bdc12c79b.png)  
공유의 특정 포트로 들어온 접속을 사설 IP의 특정 포트로 전달하도록 설정하는 것  
사설 IP를 할당받은 기기를 웹서버로 활용해 외부에서 사설 IP에 접근이 필요한 경우 공유기로 들어온 요청을 해당 기기로 전달한다.  

## 서브넷
하나의 네트워크를 나누어 효율적으로 사용하기 위한 네트워크 안의 네트워크
서브넷 마스크를 이용해 서브넷에 마스크를 씌워 필요없는 IP는 가림으로써 네트워크를 나눔
네트워크를 운영 중인 서비스의 규모에 맞게 분할해 낭비되는 IP주소 자원을 최소화하는 것이 주된 목적  
연결된 디바이스가 많아지면 오는 성능의 저하를 서브넷을 통해 사용 가능한 네트워크의 규모를 줄여 부하를 줄일 수 있다.  

### 서브넷 마스크
- IP주소와 같이 32비트로 구성
IP 주소와 서브넷 마스크 주소를 AND 연산하면 네트워크 주소를 구할 수 있다.  

### CIDR(Class InterDomain Routing)  
클래스 주소보다 유연하게 IP 주소를 나눠주는 라우팅 기법  
IP 주소를 a.b.c.d/x로 표현  
x는 처음 나오는 주소의 prefix로 비트 수를 의미  
서브넷 마스크를 개수로 표현하는 것으로 `/<개수>`를 보고 이를 통해 CIDR로 서브넷을 나눈다. 

### DHCP(Dynamic Host Configuration Protocol)  
![dhcp](https://user-images.githubusercontent.com/43775108/125108826-8238e500-e11d-11eb-8e0d-3b45d5efc130.png)  
클라이언트-서버 프로토콜로 동적으로 IP 주소를 할당해주는 것이다.  
IP 주소는 수동으로 할당받을 수도 있다.  
다음과 같은 과정을 통해 동작한다.  
1. DHCP 서버 발견: 새롭게 도착한 호스트는 브로드캐스팅을 통해 DHCP에 메시지 전송  
2. DHCP 서버 제공: DHCP가 제공 메시지를 호스트에 전송  
3. DHCP 요청: 호스트가 DHCP 요청 메시지 전송  
4. DHCP ACK: 서버는 DHCP 요청 메시지에 대한 응답 전송  

### 브로드캐스트  
특정 네트워크에 속하는 모든 호스트들이 보는 주소  
할당된 호스트가 192.168.12.0부터 192.168.12.255라면 브로드캐스트주소는 192.168.12.255이다.
네트워크 주소에서 서브넷마스크의 0으로 된 비트를 모두 1로 바꾸면 브로드캐스트  

### 게이트웨이  
서로 다른 통신망, 프로토콜을 사용하는 네트워크가 연결해주기 위해 지나는 네트워크 포인트. 1번이나 254번을 할당한다.  
종류가 다른 네트워크 간의 통로 역할로, 외부와 내부 네트워크를 연결하는 인터페이스가 될 수도 있다.  

![gateway](https://user-images.githubusercontent.com/43775108/125113627-dd6dd600-e123-11eb-9b56-24d0e85caab2.png)  
1. 컴퓨터1에서 컴퓨터6에 접속하려면 라우터의 IP주소(기본 게이트웨이)를 설정해야 한다.  
2. 컴퓨터1은 다른 네트워크로 어디로 전송해야할 지 몰라 네트워크의 출입구(기본 게이트웨이)를 지정하고 라우터로 전송한다. 
3. 라우터가 IP를 확인해 목적지까지 보낸다.  

#### 정리
[바다](https://www.notion.so/CS-IP-e252cafa1c53439c97630423425451bc), [파피](https://www.notion.so/IP-d44a327381f746cf94582e761c155719), [우기](https://jujubebat.github.io/cs/IP-Address/), [제리](https://www.notion.so/IP-4df05ce6fadd47bf93291f858dfc3d98), [피카](https://github.com/pika96/TIL/blob/master/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/IP%20%EC%A3%BC%EC%86%8C%EC%99%80%20%EC%84%9C%EB%B8%8C%EB%84%B7%20%EB%A7%88%EC%8A%A4%ED%81%AC.md), [마크](https://github.com/binghe819/TIL/blob/master/Network/%EB%AA%A8%EB%91%90%EC%9D%98%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/4.%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%EA%B3%84%EC%B8%B5.md)  
